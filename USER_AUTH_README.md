# AI问题测试系统 - 用户认证和权限管理

## 功能概述

本系统实现了完整的用户认证和权限管理机制，包括三种用户角色和审核员申请流程。

## 用户角色

### 1. 普通用户 (user)
- 可以注册账号
- 上传题目并运行测试
- 查看自己上传题目的测试结果
- 申请成为审核员

### 2. 审核员 (reviewer)
- 拥有普通用户的所有权限
- 可以查看所有题目和测试结果
- 可以进行人工审核
- 需要申请并由管理员审批

### 3. 管理员 (admin)
- 拥有所有权限
- 审批审核员申请
- 管理所有用户和数据
- 只能通过后台脚本创建

## 快速开始

### 1. 创建管理员账号

```bash
# 方法1: 使用快速创建脚本
python create_admin.py admin admin123

# 方法2: 使用交互式管理工具
python manage_admin.py
```

### 2. 启动应用

```bash
python run.py
```

应用将在 http://127.0.0.1:5000 启动

### 3. 登录系统

访问 http://127.0.0.1:5000/auth/login

**默认管理员账号**:
- 用户名: admin
- 密码: admin123

## 使用流程

### 普通用户注册和使用

1. 访问 `/auth/register` 注册账号
2. 登录后访问 `/questions/new` 上传题目
3. 系统自动运行测试
4. 在 `/testing/results` 查看自己题目的测试结果
5. 如需成为审核员，访问 `/auth/apply-reviewer` 申请

### 审核员申请流程

1. 普通用户登录后，点击用户下拉菜单中的"申请成为审核员"
2. 填写申请理由（至少10个字符）
3. 提交申请，等待管理员审批
4. 管理员在 `/auth/admin/applications` 审批申请
5. 申请通过后，用户角色自动升级为审核员

### 审核员进行人工审核

1. 审核员登录后，访问 `/testing/review-list`
2. 查看待审核的测试结果列表
3. 点击"审核"按钮进入审核页面
4. 查看题目信息、AI测试结果和8次测试详情
5. 选择"通过"或"不通过"，可添加审核备注
6. 提交审核结果

### 管理员管理用户

1. 管理员登录后，访问 `/auth/admin/applications`
2. 查看所有审核员申请
3. 可以通过或拒绝申请，并添加审批备注
4. 使用 `manage_admin.py` 脚本管理用户角色

## 权限说明

### 题目管理
- 普通用户：只能查看、编辑、删除自己上传的题目
- 审核员：可以查看所有题目
- 管理员：可以管理所有题目

### 测试结果
- 普通用户：只能查看自己题目的测试结果
- 审核员：可以查看所有测试结果，进行人工审核
- 管理员：拥有所有权限，包括批量删除

### 导出功能
- 普通用户：无导出权限
- 审核员：可以导出测试结果
- 管理员：可以导出所有数据

## 管理工具

### create_admin.py - 快速创建管理员
```bash
python create_admin.py <用户名> <密码>
```

### manage_admin.py - 交互式管理工具
```bash
python manage_admin.py
```

功能：
1. 创建管理员账号
2. 查看所有用户
3. 修改用户角色

## 数据库结构

### users 表
- id: 用户ID
- username: 用户名（唯一）
- password_hash: 密码哈希
- role: 角色（admin/reviewer/user）
- created_at: 创建时间

### reviewer_applications 表
- id: 申请ID
- user_id: 申请人ID
- reason: 申请理由
- status: 状态（pending/approved/rejected）
- applied_at: 申请时间
- reviewed_at: 审批时间
- reviewed_by: 审批人ID
- review_comment: 审批备注

### questions 表
- user_id: 上传者ID（新增字段）
- 其他字段保持不变

## 安全特性

1. 密码使用 Werkzeug 的 pbkdf2:sha256 哈希存储
2. 所有路由都需要登录认证
3. 基于角色的访问控制（RBAC）
4. 用户只能访问自己有权限的资源
5. 管理员账号不能通过注册创建

## 注意事项

1. 首次使用前必须创建管理员账号
2. 普通用户注册后默认角色为 user
3. 审核员必须通过申请流程获得
4. 管理员账号请妥善保管
5. 生产环境请修改默认管理员密码

## 技术栈

- Flask-Login: 用户会话管理
- Werkzeug: 密码哈希
- SQLAlchemy: 数据库ORM
- Bootstrap 5: 前端UI

## 更新日志

### v2.0 - 用户认证和权限管理
- 添加用户注册和登录功能
- 实现三种用户角色
- 添加审核员申请流程
- 实现基于角色的权限控制
- 题目自动关联上传者
- 人工审核自动记录审核人
