{% extends "base.html" %}

{% block title %}测试详情 - AI问题测试系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>测试详情</h2>
            <div>
                <a href="{{ url_for('questions.view_question', question_id=test_result.question.id) }}" class="btn btn-primary">返回问题详情</a>
                <a href="{{ url_for('testing.test_list') }}" class="btn btn-secondary">返回列表</a>
            </div>
        </div>

        <!-- Test Summary -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">测试摘要</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>问题标题:</strong> {{ test_result.question.title }}</p>
                        <p><strong>测试日期:</strong> {{ test_result.test_date.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <p><strong>总尝试次数:</strong> {{ test_result.total_attempts }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>正确次数:</strong> {{ test_result.correct_count }}</p>
                        <p><strong>成功率:</strong>
                            <span class="badge bg-{{ 'success' if test_result.success_rate < 50 else 'danger' }} fs-6">
                                {{ test_result.success_rate }}%
                            </span>
                        </p>
                        <p><strong>难度状态:</strong> {{ test_result.difficulty_status }}</p>
                        <p><strong>是否合格:</strong>
                            {% if test_result.qualified %}
                                <span class="badge bg-success fs-6">合格 (成功率 &lt; 50%)</span>
                            {% else %}
                                <span class="badge bg-danger fs-6">不合格 (成功率 &ge; 50%)</span>
                            {% endif %}
                        </p>
                        <p><strong>人工审核:</strong>
                            {% if test_result.manual_review_status == 'pending' %}
                                <span class="badge bg-warning fs-6">待审核</span>
                            {% elif test_result.manual_review_status == 'approved' %}
                                <span class="badge bg-success fs-6">通过 ✓</span>
                            {% elif test_result.manual_review_status == 'rejected' %}
                                <span class="badge bg-danger fs-6">不通过 ✗</span>
                            {% endif %}
                        </p>
                        {% if test_result.manual_review_status != 'pending' %}
                        <p><strong>审核人员:</strong> {{ test_result.manual_reviewed_by }}</p>
                        <p><strong>审核时间:</strong> {{ test_result.manual_review_time.strftime('%Y-%m-%d %H:%M') }}</p>
                        {% if test_result.manual_review_comment %}
                        <p><strong>审核备注:</strong> {{ test_result.manual_review_comment }}</p>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('testing.review_test', test_result_id=test_result.id) }}"
                       class="btn btn-{{ 'warning' if test_result.manual_review_status == 'pending' else 'secondary' }}">
                        {{ '进行人工审核' if test_result.manual_review_status == 'pending' else '重新审核' }}
                    </a>
                </div>
            </div>
        </div>

        <!-- Question Details -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">问题信息</h5>
            </div>
            <div class="card-body">
                <p><strong>问题:</strong></p>
                <div class="latex-preview mb-3">
                    {{ test_result.question.question_text }}
                </div>

                <p><strong>标准答案:</strong></p>
                <div class="alert alert-success">
                    {{ test_result.question.standard_answer }}
                </div>

                <p><strong>解题思路:</strong></p>
                <div class="alert alert-info">
                    {{ test_result.question.solution_approach }}
                </div>
            </div>
        </div>

        <!-- API Call Logs -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">详细测试记录</h5>
            </div>
            <div class="card-body">
                {% if api_logs %}
                    {% for log in api_logs %}
                    <div class="card mb-3 border-{{ 'success' if log.is_correct else 'danger' }}">
                        <div class="card-header bg-{{ 'success' if log.is_correct else 'danger' }} text-white">
                            <strong>尝试 #{{ log.attempt_number }}</strong>
                            <span class="float-end">
                                {{ '✓ 正确' if log.is_correct else '✗ 错误' }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p><strong>时间:</strong> {{ log.call_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>

                            {% if log.error_message %}
                                <div class="alert alert-danger">
                                    <strong>错误:</strong> {{ log.error_message }}
                                </div>
                            {% else %}
                                <p><strong>AI回答:</strong></p>
                                <div class="alert alert-light">
                                    {{ log.ai_answer }}
                                </div>

                                <p><strong>验证响应:</strong></p>
                                <div class="alert alert-light">
                                    {{ log.verification_response }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">没有测试记录</p>
                {% endif %}
            </div>
        </div>

        <!-- Export Button -->
        <div class="mt-4">
            <form method="POST" action="{{ url_for('testing.export_results') }}">
                <input type="hidden" name="test_result_ids" value="{{ test_result.id }}">
                <button type="submit" class="btn btn-primary">导出此测试结果</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
